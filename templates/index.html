<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Stream and Play Audio</title>
  <script>
    var audioctx = {
      current_track: -1,
    }

    document.addEventListener('DOMContentLoaded', function () {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioContext.createBufferSource();
      let queue = [];
      let buffers = [];

      async function fetchAudio() {
        // if current track is not defined, use /get to update the audio context first
        if (audioctx.current_track === -1) {
          const response = await fetch('/get');
          const data = await response.json();
          audioctx.current_track = data.current_track;
        }

        const response = await fetch('/play?current_track=' + audioctx.current_track);
        const reader = response.body.getReader();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          audioContext.decodeAudioData(value.buffer, (buffer) => {
            queue.push(buffer);
            if (queue.length === 1) {
              playAudio();
            }
            else {
              // Add up all the durations of the audio buffers in the queue
              // and subtract the amount of audio that has already been played
              const total_duration = queue.reduce((acc, buffer) => acc + buffer.duration, 0);
              const played_duration = audioContext.currentTime - audioContext.baseLatency;
              const schedule_playback_seconds = total_duration - played_duration;
              playAudio(schedule_playback_seconds);
            }
          }, (e) => {
            console.log("Error decoding audio data", e);
          });
        }
      }

      function playAudio(schedule_playback_seconds = 0) {
        if (queue.length > 0) {
          const buffer = queue.shift();
          const bufferSource = audioContext.createBufferSource();
          bufferSource.buffer = buffer;
          bufferSource.connect(audioContext.destination);
          bufferSource.start(schedule_playback_seconds);
          buffers.push(bufferSource);
          bufferSource.onended = () => {
            buffers.shift();
          }
        }
      }

      fetchAudio();
    });
  </script>
</head>

<body>
  <h1>Streaming Audio Player</h1>
  <p>Audio is being streamed and played...</p>
</body>

</html>
