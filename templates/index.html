<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minimal Music Player</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
      /* Default light theme */
      background-color: #fff;
      color: #000;
    }

    audio {
      width: 100%;
      max-width: 600px;
    }

    #metadata,
    #skip-button {
      margin-top: 20px;
    }

    /* Dark theme styles */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #333;
        color: #fff;
      }

      a {
        color: #4a90e2;
        /* A lighter blue for better visibility on dark backgrounds */
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
  <script>
    let audioctx = {
      current_track: -1,
      current_chunk: -1,
    }

    var context = new (window.AudioContext || window.webkitAudioContext)();

    function init() {
      // Merge two audio buffers into one.
      function appendBuffer(buffer1, buffer2) {
        var numberOfChannels = Math.min(buffer1.numberOfChannels, buffer2.numberOfChannels);
        var tmp = context.createBuffer(numberOfChannels, (buffer1.length + buffer2.length), buffer1.sampleRate);
        for (var i = 0; i < numberOfChannels; i++) {
          var channel = tmp.getChannelData(i);
          channel.set(buffer1.getChannelData(i), 0);
          channel.set(buffer2.getChannelData(i), buffer1.length);
        }
        return tmp;
      }

      function loadSongWebAudioAPI() {
        if (audioctx.current_track == -1) {
          $.get('/get', audioctx, function (data) {
            audioctx.current_track = data.current_track;
            audioctx.current_chunk = 0;
            fetchMetadata();
            loadSongWebAudioAPI();
          });
          return;
        }

        var request = new XMLHttpRequest();
        request.open('GET', '/play?current_track=' + audioctx.current_track + '&current_chunk=' + audioctx.current_chunk, true);
        request.responseType = 'arraybuffer';

        function play(arrayBuffer) {
          context.decodeAudioData(arrayBuffer, function (audioBuffer) {
            var audioElement = document.getElementById('audioElement');
            var source = context.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(context.destination);
            source.start(0);
            source.onended = function () {
              audioctx.current_chunk++;
              loadSongWebAudioAPI();
            }
          }, function () {
            console.log('Error decoding audio data');
          });
        }

        // When the song is loaded asynchronously try to play it.
        request.onload = function () {
          play(request.response);
        }

        request.send();
      }

      loadSongWebAudioAPI();
    }

    window.addEventListener('load', init, false);

    // Skip song button
    $('#skip-button').click(function () {
      audioctx.current_track = -1;
      audioctx.current_chunk = -1;
      loadSongWebAudioAPI();
    });

    // Fetch metadata
    function fetchMetadata() {
      $.get('/metadata', audioctx, function (data) {
        $('#metadata').html(data);
      });
    }
  </script>
</head>

<body>
  <h1>Minimal Music Player</h1>
  <audio controls id="audioElement"> </audio>
  <div id="metadata">Loading track information...</div>
  <button id="skip-button">Skip song</button>
</body>

</html>
