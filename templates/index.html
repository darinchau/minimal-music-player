<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Audio Stream Example</title>
</head>

<body>
  <h1>Audio Stream Example</h1>
  <button id="playButton">Play Stream</button>

  <script type="module">
    document.getElementById('playButton').addEventListener('click', async () => {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      await audioContext.audioWorklet.addModule('audio.js')
      const audioNode = new AudioWorkletNode(audioContext, 'audio-processor');
      audioNode.connect(audioContext.destination);

      const response = await fetch('/play');
      const reader = response.body.getReader();

      async function read() {
        const { value, done } = await reader.read();
        if (done) {
          return;
        }
        const audioBuffer = await audioContext.decodeAudioData(value.buffer);
        audioNode.port.postMessage({ audioBuffer });
        read();
      }

      read();
    });
  </script>
</body>

</html>
