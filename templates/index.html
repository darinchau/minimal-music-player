<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minimal Music Player</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
      /* Default light theme */
      background-color: #fff;
      color: #000;
    }

    audio {
      width: 100%;
      max-width: 600px;
    }

    #metadata,
    #skip-button {
      margin-top: 20px;
    }

    /* Dark theme styles */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #333;
        color: #fff;
      }

      a {
        color: #4a90e2;
        /* A lighter blue for better visibility on dark backgrounds */
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
  <script>
    let context = {
      currentTrack: -1,
      current_chunk: -1,
    }
    const audioFormat = "audio/ogg";
    document.addEventListener('DOMContentLoaded', function () {
      const mediaSource = new MediaSource();
      const audioElement = document.getElementById('audioElement');
      let sourceBuffer;
      let queue = [];

      audioElement.src = URL.createObjectURL(mediaSource);

      // Add the pause event
      audioElement.addEventListener('pause', function () {
        if (audioElement.paused) {
          audioElement.play();
          if (mediaSource.readyState === 'closed') {
            mediaSource.addSourceBuffer(audioFormat);
          }
        } else {
          audioElement.pause();
        }
      });

      mediaSource.addEventListener('sourceopen', function () {
        sourceBuffer = mediaSource.addSourceBuffer(audioFormat);
        sourceBuffer.mode = 'sequence';
        fetchStream();
      });

      function fetchStream() {
        const url = "/play";
        const xhr = new XMLHttpRequest();
        // Send a GET request with the current context
        xhr.open('GET', url + '?current_track=' + context.current_track + '&current_chunk=' + context.current_chunk, true);
        xhr.responseType = 'arraybuffer';

        xhr.onload = function () {
          if (xhr.status === 200) {
            queue.push(xhr.response);
            if (!sourceBuffer.updating && queue.length) {
              sourceBuffer.appendBuffer(queue.shift());
            }
          } else {
            console.error('Failed to fetch the audio stream.');
          }
        };

        xhr.onprogress = function () {
          if (xhr.response) {
            queue.push(xhr.response);
            xhr.response = null;
            if (!sourceBuffer.updating && queue.length) {
              sourceBuffer.appendBuffer(queue.shift());
            }
          }
        };

        xhr.send();
      }

      sourceBuffer.addEventListener('updateend', function () {
        if (queue.length > 0 && !sourceBuffer.updating) {
          sourceBuffer.appendBuffer(queue.shift());
        }
        if (!audioElement.paused && mediaSource.readyState === 'open' && sourceBuffer.buffered.length && audioElement.currentTime > sourceBuffer.buffered.end(0)) {
          mediaSource.endOfStream();
        }
      });
    });

    // Skip song button
    $('#skip-button').click(function () {
      $.get('/skip', context, function (data) {
        context = data;
        fetchMetadata();
      });
    });

    // Fetch metadata
    function fetchMetadata() {
      $.get('/metadata', context, function (data) {
        $('#metadata').html(data);
      });
    }
  </script>
</head>

<body>
  <h1>Minimal Music Player</h1>
  <audio controls id="audioElement"> </audio>
  <div id="metadata">Loading track information...</div>
  <button id="skip-button">Skip song</button>
</body>

</html>
